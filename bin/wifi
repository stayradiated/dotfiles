#!/usr/bin/env zsh

set -euxo pipefail

action=$1
ssid=${2:-}
psk=${3:-}

if test "${action}" = "status"; then
  as-host wpa_cli status
elif test "${action}" = "list"; then
  as-host wpa_cli list_networks
elif test "${action}" = "join"; then
  id=$(as-host wpa_cli add_network | tail -n 1)
  as-host wpa_cli set_network "${id}" ssid "${ssid}"
  if test "${psk}" = ""; then
    as-host wpa_cli set_network "${id}" key_mgmt NONE
  else
    as-host wpa_cli set_network "${id}" psk "${psk}"
  fi
  as-host wpa_cli enable_network "${id}"
elif test "${action}" = "scan"; then
  as-host wpa_cli scan
  as-host wpa_cli scan_results | tail -n +3 | sd '\t' ',' | xsv table
else
  echo "status, list, join, scan"
fi
