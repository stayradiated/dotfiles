#!/usr/bin/env zsh

#
# xd --right
# xd --left
# xd --above
# xd --mirror
# xd --resolution 1920x1080
# xd --reset
#


set -euo pipefail

echo "Starting monitor configuration..."

# Get a list of connected displays (excluding eDP-1)
connected_displays=$(xrandr --query | grep " connected " | grep -v "eDP-1" | cut -d ' ' -f1 || true)

if [ -z "$connected_displays" ]; then
  echo "No external displays detected!"
  exit 0
fi

echo "Connected displays: $connected_displays"

# Check if a custom resolution was provided as an argument
custom_resolution=""
if [ $# -ge 1 ]; then
  # Validate that the argument matches the resolution format (e.g., 1280x800)
  if [[ $1 =~ ^[0-9]+x[0-9]+$ ]]; then
    custom_resolution=$1
    echo "Using custom resolution: $custom_resolution"
  else
    echo "Invalid resolution format. Expected format: WIDTHxHEIGHT (e.g., 1280x800)"
    exit 1
  fi
fi

# For each connected display, apply resolution
for display in $connected_displays; do
  echo "Configuring $display..."
  
  if [ -n "$custom_resolution" ]; then
    # Check if the requested resolution is available
    available_res=$(xrandr --query | grep -A 20 "^$display connected" | grep -o '[0-9]\+x[0-9]\+' | grep -x "$custom_resolution")
    
    if [ -n "$available_res" ]; then
      echo "Setting $display to custom resolution $custom_resolution"
      xrandr --output $display --mode $custom_resolution --primary
    else
      echo "Warning: Custom resolution $custom_resolution not available for $display"
      echo "Available resolutions:"
      xrandr --query | grep -A 20 "^$display connected" | grep -o '[0-9]\+x[0-9]\+' | sort -rV
      
      # Get the highest resolution as fallback
      highest_res=$(xrandr --query | grep -A 20 "^$display connected" | grep -o '[0-9]\+x[0-9]\+' | sort -rV | head -1)
      
      if [ -n "$highest_res" ]; then
        echo "Falling back to highest available resolution: $highest_res"
        xrandr --output $display --mode $highest_res --primary
      fi
    fi
  else
    # No custom resolution provided, use highest available
    highest_res=$(xrandr --query | grep -A 20 "^$display connected" | grep -o '[0-9]\+x[0-9]\+' | sort -rV | head -1)
    
    if [ -n "$highest_res" ]; then
      echo "Setting $display to $highest_res"
      xrandr --output $display --mode $highest_res --primary
    fi
  fi
  
  # Set the first external display as primary and exit
  # If you want to extend across multiple displays, remove this exit
  exit 0
done

echo "Monitor configuration complete!"
