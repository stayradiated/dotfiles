#!/usr/bin/env zsh

set -e

# Get current branch name
current_branch=$(jj log --no-graph -T 'local_bookmarks' --limit 2 | cut -d ' ' -f 1)

if [[ -z "$current_branch" || "$current_branch" == "main" ]]; then
    echo "âŒ Error: Not on a feature branch or unable to determine branch name"
    exit 1
fi

echo "ğŸ” Current branch: $current_branch"

# Check if PR exists for this branch
if ! gh pr view "$current_branch" --json number >/dev/null 2>&1; then
    echo "âŒ Error: No PR found for branch '$current_branch'"
    echo "   Create a PR first with: gh pr create"
    exit 1
fi

pr_number=$(gh pr view "$current_branch" --json number --jq '.number')
echo "ğŸ“‹ Found PR #$pr_number"

# Get diff from GitHub
echo "â¬‡ï¸  Fetching diff from GitHub..."
diff_content=$(gh pr diff "$pr_number")

# Get commit messages from GitHub
echo "ğŸ“ Fetching commit messages from GitHub..."
commit_messages=$(gh pr view "$pr_number" --json commits --jq '.commits[] | "- \(.messageHeadline)\n  \(.messageBody // "")"' | sed '/^  $/d')

# Combine all information for the LLM
combined_input="# Pull Request Diff:
$diff_content

# Commit Messages:
$commit_messages"

echo "............................................................"
echo $combined_input
echo "............................................................"

# Generate new description using LLM
echo "ğŸ¤– Generating PR description..."
echo "============================================================"

output=$(printf '%s\n' "$combined_input" | llm -s "$(cat ~/dotfiles/apps/llm/prompts/gh-pull-request-prompt.txt)" | tee /dev/tty)

output=$(printf '%s' "$raw_output" \
  | sed -E 's/\x1B\[[0-9;:]*[A-Za-z]//g' \
  | tr -d '\000-\010\013\014\016-\037') \
  | jq .

description=$(printf '%s' "$output" | jq -r '.content')
title=$(printf '%s' "$output" | jq -r '.title')

echo
echo "============================================================"

# Update the PR description
echo "ğŸ“¤ Updating PR description..."
gh pr edit "$pr_number" --title "$title" --body "$description"

echo "âœ… PR description updated successfully!"
echo "ğŸ”— View at: $(gh pr view "$pr_number" --json url --jq '.url')"
